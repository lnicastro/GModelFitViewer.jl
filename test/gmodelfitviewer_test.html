<!DOCTYPE html>
<html>
<head>
  <title>The GModelFit viewer</title>
  <meta http-equiv=Content-Type content="text/html; charset=UTF-8" />
  <meta http-equiv=Content-Script-Type content="text/javascript" />
  <meta http-equiv=Content-Style-Type content="text/css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="GModelFitViewer - web viewer for the GModelFit produced results" />
  <meta name="generator" content="vi+LN" />
  <meta name="author" content="Luciano Nicastro, INAF" />
  <meta name="publisher" content="INAF" />
  <meta name="language" content="en" />
  <meta name="version" content="x.y.z" />
  <meta name="date" content="xxxx-yy-dd" />

  <link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACwVBMVEVLQTkAAAAQNQDv9vqWWUIYSADPv8T///8fAABWIgBpNQBXCwB4LwBsEAAxmQCaNACMJwCGFAA8sQCrOgBtAACWGABByADFRwCsGABJ4wDWVACrGQBU9gD2dADtYQAAPAAJDQAJDQALDQAMDQANDAANCwDKnZPKn5axf3GMYlZwVlEKAAACAAAJFAALEwAPEwAREgAREAAPDwDIl4uMbmaAZ2C0kIiVZ1kOAAAQAAAPAAAMJAAOHgAWGQAVGQAUFwASEgAAAACziH1yV06beG4XAAAWAAATAAANAAAQNQAQNQChdWerfnCjg3uNcGipg3kAAAAqAAAhAAAcAAAVAAAXSAAYSAClgnj7xbdiNyRYLBhAAAA4AAAsAAAiAAAaAAAdWQApZABDcgBWaQBhXwBiUQBjUABUGQBTGABfIQBEAABAAAA2AAArAAAdAAAkbQAybwBHcQBfbwBsZwBqWABpVABqHwBpHABqGABKAABCAAA3AAAcAAAqgwA0dgBNcQBndgBxcABtYABrVgB8JQB6HwB5GQBaAABOAABBAAAqAAAumQAxmQCPLQCOIwCTHABoAABbAABLAAAoAAA2sAA8sQClNACjJwCfHQB4AABoAABXAAA0AAA8xwBCxwDFSwC8PgC5HQCIAAB1AABiAAA/AABE4QBJ4wDWVgDSSADRHACWAACDAABrAABVAABM+QBU9wDvZQDqUgDqFgDyAACMAABxAABSAABQ/wBo/wCo/wDc/wD78QD8ywD6oAD2dQDzEgDyAADQAACWAAByAABTAABS/wB0/wCk/wDc/wD78QD8ygD5ogD3ewDwAADOAAChAAB2AABTAABS/wB0/wCk/wDc/wD78QD8ygD5owD3fAD0WAD0NwDzEQDwAADOAAChAAB3AABTAABNNSm8KgDPLwDnMwD0WAD0NwDzEQD////W1nz1AAAA43RSTlMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHp7e3t9RhQoCwkBAgL77Onp7YMZtuOYLwyOc9s/KCoqKhVR+JMT1qwD1BocRovAPAEl2bMW1BoFARZULcr48NLbPygqKicIK5EEE2Tly1/87evr7NorR8APE9asA+Z7a2xsZBRh3x4T1qwD1Bp98DAT1qwD1Bqb/k4T1qwD1BoHum0T1q4D1Boa2JIPzcUQ1BpC9MQOkfi2iSEREhISGp70XRMpkcnQ0dLS0tHa+u/XycbO+fn5+fn5+Pb19fX2+Pn5+dfu6+cAAAABYktHRAcWYYjrAAAAB3RJTUUH5QQICR4OhkGH6QAAARtJREFUGNMBEAHv/gAgISEiIyQlACYnKCkqKywBAC0uLzAwMTIzNDU2Nzg5OisAOzw9Pj9AQUJD40QBRUZHSABJSgIBAwRLTE1OT1BRUlNUAFVWBQEGB1dYWVoIW1xdXl8AYGFiY2RlZglnaGlqa2xtbgBvcHFyc3R1CnZ3eAt5ent8AH1+f4CBgoMMhIWGDYeIiYoAi4wOAQEBDxCNjo8RkJGSkwCUlRIBAQETFJaXmBWZmpucAJ2eFgEBARefoOShGKKjpKUApqcZAQEBGqip5aobq6ytrgCvsBwBAR0esbLms7Qftba3ALi5uru8vb6/5+jAwcLDxMUAxsfIycrLzM3n6OnOz9DR0gDT1NXW19jZ2tvc3d7f4OHiz4ts2nSh7t4AAAAldEVYdGRhdGU6Y3JlYXRlADIwMjEtMDQtMDhUMDk6MzA6MTQrMDI6MDANVBBwAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIxLTA0LTA4VDA5OjMwOjE0KzAyOjAwfAmozAAAAFd6VFh0UmF3IHByb2ZpbGUgdHlwZSBpcHRjAAB4nOPyDAhxVigoyk/LzEnlUgADIwsuYwsTIxNLkxQDEyBEgDTDZAMjs1Qgy9jUyMTMxBzEB8uASKBKLgDqFxF08kI1lQAAAABJRU5ErkJggg==" sizes="16x16" rel="icon" type="image/x-icon" />


<!-- @Remote -->
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

  <script src="https://cdn.amcharts.com/lib/4/plugins/annotation.js"></script>
<!-- @EndRemote -->


<style>
body {
  font: 0.98em adobe-clean-n3, adobe-clean, "Helvetica Neue", HelveticaNeue, Helvetica, Arial, sans-serif;
  color: #333;
  margin: 5px;
  text-rendering: optimizeLegibility !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
}

:root {
--blue: #1177d1;
--indigo: #6610f2;
--purple: #613d7c;
--pink: #e83e8c;
--red: #d43f3a;
--orange: #f0ad4e;
--yellow: #ff7518;
--green: #398439;
--teal: #20c997;
--cyan: #5bc0de;
--gray: #6c757d;
--gray-dark: #343a40;
--primary: #1177d1;
--secondary: #ced4da;
--success: #398439;
--info: #5bc0de;
--warning: #f0ad4e;
--danger: #d43f3a;
--light: #f8f9fa;
--dark: #343a40;

--baseFg: dimgray;
--baseBg: white;
--accentFg: #69c;
--accentBg: #bae1ff;
}

a:link, a:visited, a:active {
  text-decoration: none;
  color: #204d74;
}

a:hover {
  color: #2d6ca2;
}

button {
  font-size: 1rem;
  vertical-align: middle;
}

button:hover {
  cursor: pointer;
}

button > i {
  margin-left: 6px;
  margin-right: 6px;
  font-size: 110%;
}

input {
  cursor: auto;
  -moz-box-sizing:content-box;
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
  font-size: 0.9rem;
}

input[type="checkbox"] {
        margin-right: 6px;
}

input[type="text"] {
  background-color: #f7f7f7;
  color: #666;
  border: 0;
  border-bottom: 2px solid #ccc;
  padding: 5px;
  vertical-align: middle;
}

input[type="text"]:hover {
  background-color: #fff;
}

input[type="number"] {
  border: 1px solid #ccc;
  padding: 5px;
}


input[type="button"], input[type="checkbox"] {
  cursor: pointer;
}

input[type="button"]:hover {
  color: #069;
}

input[type="file"] {
    display: none;
}


img {
  border: 0;
  vertical-align: middle;
}

progress[value] {
  width: 200px;
  height: 5px;
}

label {
  padding-left: .3em;
  font-weight: bold;
}

.container {
  margin: 16px;
  font-size: 110%;
}


#inaf-logo {
  width: 173px;
  margin: 1px 0;
}

.img-circle {
  border-radius: 50%;
  box-shadow: 0px 0px 3px 3px #ddd;
}

.shadow {
  -webkit-box-shadow: 3px 3px 5px 6px #ccc;
  box-shadow:         3px 3px 5px 6px #ccc;
}

.hdrdiv2 {
  width : 100%;
  text-align: left;
  padding: 0 1px;
  color: #fff;
  background-color: #186680;
  font-size: 1.2rem;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.logo-div {
  display: inline-block;
  vertical-align: middle;
  padding: 8px;
  margin-top: 1px;
  background: #f7f7f7;
  border-top-right-radius: 36px;
}

.app-info-div {
  float: right;
  font-size: .9rem;
  background: #186680;
  border-radius: 5px;
}

.submit_grey {
  font-weight: normal;
  background-image: linear-gradient(to bottom,#fff 0,#e0e0e0 100%);
  background-repeat: repeat-x;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.15),0 1px 1px rgba(0,0,0,0.075);
  color: #333;
  background-color: #fff;
  display: inline-block;
  padding: 6px;
  margin-bottom: 0;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.submit_grey:hover {
  cursor: pointer;
  background-image: none;
  background-color: #e0e0e0;
  border: 1px solid #adadad;
}


.dd-select {
  font-size: inherit;
  height: 2rem;
  margin: 0;
  padding-right: 1.5rem;
  color: #333;
  border: 1px solid #666;
  border-radius: 4px;
  webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  background-color: var(--baseBg);
  background-image: linear-gradient(var(--baseFg), var(--baseFg)),
    linear-gradient(-135deg, transparent 50%, var(--light) 50%),
    linear-gradient(-225deg, transparent 50%, var(--light) 50%),
    linear-gradient(var(--light) 42%, var(--accentFg) 42%);
  background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
  background-size: 1px 100%, 20px 22px, 20px 22px, 20px 100%;
  background-position: right 20px center, right bottom, right bottom, right bottom;
}

.dd-select:hover {
background-image: linear-gradient(var(--accentFg), var(--accentFg)),
    linear-gradient(-135deg, transparent 50%, var(--accentFg) 50%),
    linear-gradient(-225deg, transparent 50%, var(--accentFg) 50%),
    linear-gradient(var(--accentFg) 42%, var(--accentBg) 42%);
}

select::-ms-expand {
    display: none; /* Remove default arrow in Internet Explorer 10 and 11 */
}


.page_top_tbar {
  background-color: #f7f7f7;
  color: #666;
  border-bottom: 1px solid #bdbec2;
  border-left: 1px solid #186680;
  border-right: 1px solid #186680;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}


.simple_button {
  padding: 3px 0;
  margin-left: 1rem;
  border: 1px solid #adadad;
  border-radius: 4px;
}

.simple_button:hover {
  background-color: #ddd;

  -webkit-transition: all 0.3s ease-in-out;
     -moz-transition: all 0.3s ease-in-out;
          transition: all 0.3s ease-in-out;
}

.transp_button {
  padding: 0;
  width: 32px;
  height: 32px;
  margin-left: 0.5rem;
  border: 2px solid #e6e6e6;
  border-radius: 50%;
  background-color: transparent;
  box-shadow: inset 0 0 0 1px #fff;
  transition: box-shadow 0.25s linear;
}

.transp_button:hover {
  box-shadow: inset 0 0 0 1.2em #eaeaea;
}

.label-range-in {
  margin-left: 0.5em;
  margin-right: 0.2em;
  font-size: inherit;
  font-weight: 600;
}

.range-in {
  max-width: 4em;
}


#chartdiv {
  width : 98%;
  height: 640px;
  overflow: hidden;
  text-align: left;
}

#res_legenddiv {
  display: inline-block;
  height: 34px;
  width: 148px;
  vertical-align: middle;
}

.box-resid-in {
  float: right;
  margin-right: 1em;
  padding-right: 4px;
  background: #efefef;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.box-cb {
  display: inline-block;
  margin-left: .5em;
  padding-right: .5em;
  background: #efefef;
  border: 1px solid #ddd;
  border-radius: 4px;
  vertical-align: middle;
  cursor: pointer;
}

.box-cb:hover {
  background-color: #ddd;
}

#controls-div {
  margin-top: 0.5em;
}

#f_status, #range-selector-div {
  display: inline-block;
  margin-left: 1em;
}


section {
  overflow-x: hidden;
}

div.row {
  clear: both;
  border: 0px;
  padding: 0px;
}

div.section {
  clear: both;
  border: 0px;
  padding: 24px 0px;
  font-size: 110%;
  color: #444;
}

div.summ-div {
  border: 0;
  padding: 0;
}

div.trailer {
  height: 6px;
  line-height: 6px;
  background-color: #006699; /* #007ba6; */
  color: #999;
  border-left: 1px solid #186680;
  border-right: 1px solid #186680;
}

div.trailer a {
  text-decoration: none;
  color: #999;
}

div.trailer a:hover {
  color: #535353;
}


caption { 
  display: table-caption;
  text-align: center;
  padding-bottom: 20px;
  padding-top: 10px;
}


table, td, th {
  border: solid 1px #ddd;
  border-collapse: collapse;
  padding: 4px 6px;
  vertical-align: top;
  white-space: nowrap;
}

th {
  text-align: center;
  font-weight: bold;
  background-color: #eaeaea;
}

td.highlight_blue {
  font-weight: bold;
  color: blue;
}


#mod_sel-div {
  font-size: 1rem;
  font-weight: bold;
  margin: 0.2rem 0.5rem;
}

#file_io-div {
  margin: 0.2rem 0.5rem;
}


/* The Modal (background) */
.modal {
  position: fixed; /* Stay in place */
  z-index: 10; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100vh; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  max-height: 100vh;  /* screen.height * .80; */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

.modal.modal-slidein {
  animation-duration: 0.5s;
  animation-name: slidein;
  animation-timing-function: linear;
}

.modal.modal-slideout {
  background-color: rgba(255, 255, 255, 0.0);
  height: 0;
  overflow: hidden;
  transition-property: all;
  transition-duration: 0.5s;
  transition-timing-function: ease-in-out;
  transition-delay: 0s;
}

.modal.modal-hide {
  height: 0;
  overflow: hidden;
  transition-property: all;
  transition-duration: 1s;
  transition-timing-function: ease-in-out;
  transition-delay: 0.2s;
}


/* Modal content */
.modal-content {
  position: relative;
  background-color: #fefefe;
  margin: 1rem auto;
  padding: 0;
  border: 1px solid #888;
  width: 90%;
  height: 80%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.5),0 6px 20px 0 rgba(0,0,0,0.2);
}

.modal-content.modal-fadein {
  animation-duration: 0.5s;
  animation-name: fadeIn;
}

.modal-content.modal-fadeout {
  animation-duration: 0.5s;
  animation-name: fadeOut;
}

.modal-header {
  padding: 0.01rem 1rem;
  background-color: #6699cc;  /*#5cb85c;*/
  color: #fff;
  font-size: 1.3rem;
}

.modal-body {
  /*height: 80vh; */
  height: inherit;
  padding: 2px 16px;
  overflow: auto; /* Enable scroll if needed */
}

.modal-body th:hover {
  background-color: #6699cc;
}

#dropzone {
  display: table;
  width: 90%;
  height: 85%;
  margin: auto;
  border: 4px dashed grey;
  background-color: #fff;
  text-align: center;
  line-height: 3rem;
  font-size: 1.5rem;
  margin-top: 1rem;
  margin-bottom: 1rem;
}

#dropzone > div {
  display: table-cell;
  vertical-align: middle;
  padding: 1rem;
}

#dropzone > div > input {
  cursor: pointer;
}



/* The modal div Close button */
.close {
  color: #fff;
  float: right;
  font-size: 40px;
  font-weight: 300;
  padding: 0px 4px 10px 4px;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}


div .visible {
  z-index: 2;
  display: block;
  opacity: 1;
  height: auto;
    -webkit-transition: all 0.60s ease-out;
       -moz-transition: all 0.60s ease-out;
            transition: all 0.60s ease-out;
}

div .hidden {
  opacity: 0; 
  height: 0;
visibility: hidden;
  overflow: hidden;
    -webkit-transition: all 0.60s ease-in;
       -moz-transition: all 0.60s ease-in;
            transition: all 0.60s ease-in;
}


#p_title {
  color: #666;
  font-size: 1.2rem;
  vertical-align: middle;
}

#p_selector {
  margin-right: 0.5em;
  vertical-align: middle;
}

div.interface
{
  border-left: 1px solid #186680;
  border-right: 1px solid #186680;
  padding: 3px 8px;
}


/* Gradient color1 - color2 - color1 */
hr.style-one {
  border: 0; height: 1px; background: #fff;
  background-image: linear-gradient(to right, #f00, #0f0, #00f);
  margin-top: 0;
}

/* Gradient transparent - color - transparent */
hr.style-two {
  border: 0; height: 1px;
  background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
}

.custom-file-select {
  border: 1px solid #ccc;
  border-radius: 4px;
  display: inline-block;
  padding: 6px 12px;
  cursor: pointer;
  line-height: 2rem;
}

.custom-file-select:hover {
  background: #ddd;
  cursor: pointer;
  text-decoration: none;
  -webkit-transition: all 0.30s ease-in;
     -moz-transition: all 0.30s ease-in;
          transition: all 0.30s ease-in;
}

#fitlog_tables_container {
 height: auto;
/* height: 28rem;
 resize: vertical;
 overflow: auto;
*/
 border-bottom: 2px solid black;
 margin-bottom: 1rem;
}

#fitlog_sect {
  font-size: 1.5em;
  font-weight: 500;
}

#fitlog_selector {
  width: auto;
  white-space: nowrap;
  margin-left: 1rem;
  font-size: 1rem;
}

.out_table {
  border: 0;
  padding: 1em 0 1em 1em;
}

.toggle_table-hdr {
  border-bottom: 3px solid #ddd;
  padding: .5em 1em;
  font-size: 1.1em;
  font-weight: 600;
  display: inline-block;
}

.toggle_table-hdr:hover {
  background-color: #eaeaea;
  cursor: pointer;
  color: #069;
  -webkit-transition: all 0.30s ease-in;
     -moz-transition: all 0.30s ease-in;
          transition: all 0.30s ease-in;
}

.inline {
  display: inline-block;
}

.inline-div {
  display: inline-block;
  vertical-align: middle;
  margin-left: 1rem;
}

.div-hide {
  display: none;
  visibility: hidden;
  height: 0;
}

.div-show {
  display: block;
  visibility: visible;
  height: auto;
}

.div-show-inline {
  display: inline-block;
  visibility: visible;
  height: auto;
}

.rep_div-show {
  display: block;
  visibility: visible;
  height: auto;
  animation: 0.5s linear 0s fadeIn;
  transition: height 0.5s 0.3s ease-in-out; 
}

.div-selected {
  border-color: #069 !important;
  border-bottom: 3px solid #2d6ca2;
  background: #efefef;
}

#fitres_div {
  padding-top: 0;
}

#fitres_table-div {
  padding-top: 0;
}

.al-right {
  text-align: right;
}

.ud-angle-l {
  margin-left: 2rem;
}

.pre_res {
  font-size: 1rem; 
}

.pre_res_bf {
  font-size: 1rem; 
  font-weight: 600; 
}

/* Icons */
[class^="icon-"],
[class*=" icon-"],
[class^="logo-"] {
	display: inline-block;
	stroke-width: 0;
	stroke: currentColor;
	fill: currentColor;
}

.logos {
/* TODO */
}


/* Add Animation */
@keyframes slidein {
  from {top: -300px; visibility: hidden;}
  to {top: 0; visibility: visible;}
}

@keyframes slideout {
  from { transform: translateY(0); visibility: visible;}
  to   { transform: translateY(-300px); visibility: hidden;}
}

@keyframes fadeIn {
   0% { opacity: 0; visibility: hidden; }
 100% { opacity: 1; visibility: visible; }
}

@keyframes fadeOut {
    0% { opacity: 1; visibility: visible; }
  100% { opacity: 0; visibility: hidden; width: 100%; }
}
</style>


</head>

<body>

<div id="hdrdiv" class="hdrdiv2">

<!-- Icons -->

<svg aria-hidden="true" style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
	<symbol id="file-import" viewBox="0 0 512 512">
	<path fill="currentColor" d="M16 288c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h112v-64zm489-183L407.1 7c-4.5-4.5-10.6-7-17-7H384v128h128v-6.1c0-6.3-2.5-12.4-7-16.9zm-153 31V0H152c-13.3 0-24 10.7-24 24v264h128v-65.2c0-14.3 17.3-21.4 27.4-11.3L379 308c6.6 6.7 6.6 17.4 0 24l-95.7 96.4c-10.1 10.1-27.4 3-27.4-11.3V352H128v136c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H376c-13.2 0-24-10.8-24-24z"/>
	</symbol>
	<symbol id="download" viewBox="0 0 512 512">
	<path fill="currentColor" d="M216 0h80c13.3 0 24 10.7 24 24v168h87.7c17.8 0 26.7 21.5 14.1 34.1L269.7 378.3c-7.5 7.5-19.8 7.5-27.3 0L90.1 226.1c-12.6-12.6-3.7-34.1 14.1-34.1H192V24c0-13.3 10.7-24 24-24zm296 376v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h146.7l49 49c20.1 20.1 52.5 20.1 72.6 0l49-49H488c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"/>
	</symbol>
	<symbol id="angle-down" viewBox="0 0 350 512">
	<path fill="currentColor" d="M143 352.3L7 216.3c-9.4-9.4-9.4-24.6 0-33.9l22.6-22.6c9.4-9.4 24.6-9.4 33.9 0l96.4 96.4 96.4-96.4c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9l-136 136c-9.2 9.4-24.4 9.4-33.8 0z"/>
	</symbol>
        <symbol id="angle-up" viewBox="0 0 350 512">
	<path fill="currentColor" d="M177 159.7l136 136c9.4 9.4 9.4 24.6 0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9 0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9 0L7 329.7c-9.4-9.4-9.4-24.6 0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/>
	</symbol>
	<symbol id="search" viewBox="0 0 512 512">
<path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/>
	</symbol>
	<symbol id="check-circle" viewBox="0 0 512 512">
<path fill="currentColor" d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 48c110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200-110.532 0-200-89.451-200-200 0-110.532 89.451-200 200-200m140.204 130.267l-22.536-22.718c-4.667-4.705-12.265-4.736-16.97-.068L215.346 303.697l-59.792-60.277c-4.667-4.705-12.265-4.736-16.97-.069l-22.719 22.536c-4.705 4.667-4.736 12.265-.068 16.971l90.781 91.516c4.667 4.705 12.265 4.736 16.97.068l172.589-171.204c4.704-4.668 4.734-12.266.067-16.971z"/>
	</symbol>
	<symbol id="times" viewBox="0 0 352 512">
<path fill="currentColor" d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/>
	</symbol>
	<symbol id="expand" viewBox="0 0 448 512">
<path fill="currentColor" d="M448 344v112a23.94 23.94 0 0 1-24 24H312c-21.39 0-32.09-25.9-17-41l36.2-36.2L224 295.6 116.77 402.9 153 439c15.09 15.1 4.39 41-17 41H24a23.94 23.94 0 0 1-24-24V344c0-21.4 25.89-32.1 41-17l36.19 36.2L184.46 256 77.18 148.7 41 185c-15.1 15.1-41 4.4-41-17V56a23.94 23.94 0 0 1 24-24h112c21.39 0 32.09 25.9 17 41l-36.2 36.2L224 216.4l107.23-107.3L295 73c-15.09-15.1-4.39-41 17-41h112a23.94 23.94 0 0 1 24 24v112c0 21.4-25.89 32.1-41 17l-36.19-36.2L263.54 256l107.28 107.3L407 327.1c15.1-15.2 41-4.5 41 16.9z"></path>
	</symbol>
	<symbol id="shrink" viewBox="0 0 512 512">
<path fill="currentColor" d="M200 288H88c-21.4 0-32.1 25.8-17 41l32.9 31-99.2 99.3c-6.2 6.2-6.2 16.4 0 22.6l25.4 25.4c6.2 6.2 16.4 6.2 22.6 0L152 408l31.1 33c15.1 15.1 40.9 4.4 40.9-17V312c0-13.3-10.7-24-24-24zm112-64h112c21.4 0 32.1-25.9 17-41l-33-31 99.3-99.3c6.2-6.2 6.2-16.4 0-22.6L481.9 4.7c-6.2-6.2-16.4-6.2-22.6 0L360 104l-31.1-33C313.8 55.9 288 66.6 288 88v112c0 13.3 10.7 24 24 24zm96 136l33-31.1c15.1-15.1 4.4-40.9-17-40.9H312c-13.3 0-24 10.7-24 24v112c0 21.4 25.9 32.1 41 17l31-32.9 99.3 99.3c6.2 6.2 16.4 6.2 22.6 0l25.4-25.4c6.2-6.2 6.2-16.4 0-22.6L408 360zM183 71.1L152 104 52.7 4.7c-6.2-6.2-16.4-6.2-22.6 0L4.7 30.1c-6.2 6.2-6.2 16.4 0 22.6L104 152l-33 31.1C55.9 198.2 66.6 224 88 224h112c13.3 0 24-10.7 24-24V88c0-21.3-25.9-32-41-16.9z"></path>
	</symbol>

<!-- Logos -->
	<symbol id="logo-inaf" viewBox="0 0 156.5 61.2">
	<g transform="matrix(1.333,0,0,-1.333,-223.620,567.710)"><g transform="translate(-1692,-1584)">
	<path d="m 1883.7977,1992.7143 c 5.1416,-4.167 5.9327,-11.7148 1.7666,-16.8593 -4.166,-5.1443 -11.7111,-5.9368 -16.853,-1.7698 -5.1416,4.1667 -5.9326,11.7148 -1.7666,16.8591 4.166,5.1446 11.7112,5.937 16.853,1.77 z" style="fill:#00adef;fill-opacity:1;fill-rule:nonzero;stroke:none"/>
	<path d="m 1898.2428,2006.6033 -3.1782,-3.9246 -3.9224,3.179 3.1782,3.9245 z" style="fill:#1478c7;fill-opacity:1;fill-rule:nonzero;stroke:none"/>
	<path d="m 1866.8156,1967.7952 -3.1783,-3.9246 -3.9226,3.1789 3.178,3.9246 z" style="fill:#1f4fa2;fill-opacity:1;fill-rule:nonzero;stroke:none"/>
	<path d="m 1914.756,1978.2402 h 3.2151 v 11.0532 h -3.2151 z" style="fill:#63696e;fill-opacity:1;fill-rule:evenodd;stroke:none"/>
	<path d="m 1922.778,1978.2402 h 2.8474 v 7.961 h 0.031 l 5.0064,-7.961 h 4.2561 v 11.0532 h -2.8477 v -7.9609 h -0.031 l -5.0369,7.9609 h -4.2253 z" style="fill:#63696e;fill-opacity:1;fill-rule:evenodd;stroke:none"/>
	<path d="m 1948.5463,1982.4807 h -4.4551 l 2.2656,4.6694 z m -9.8286,-4.2405 h 3.3066 l 1.0718,2.1892 h 6.4299 l 1.041,-2.1892 h 3.5977 l -5.741,11.0532 h -3.8428 z" style="fill:#63696e;fill-opacity:1;fill-rule:evenodd;stroke:none"/>
	<path d="m 1958.1,1978.2402 h 3.2151 v 4.1336 h 5.4196 v 2.2656 h -5.4196 v 2.2964 h 5.7409 v 2.3576 h -8.956 z" style="fill:#63696e;fill-opacity:1;fill-rule:evenodd;stroke:none"/>
	</g></g>
	</symbol>
  </defs>
</svg>


  <div class="logo-div">
<svg class="logos" width="128" height="48"><use href="#logo-inaf"></use></svg>
  </div>

  <div class="inline-div">
    <div class="inline"><a style="color: #fff; font-weight: bold;" href="https://github.com/lnicastro/GModelFitViewer.jl" target="_new">GModelFitViewer</a> &minus;
      <div id="version-div" class="inline" style="font-size: 1rem; font-style: italic; color: #ccc;">Version x.y.z</div>
    </div>

    <div style="font-size: 1rem; margin-top: 0.5em;">A viewer for <a href="https://github.com/gcalderone/GModelFit.jl" style="color: #fff; font-weight: bold;" target="_new">GModelFit</a> 1D results
&minus;
      <div class="inline" style="font-size: .8rem;"><a style="color: #ccc;" href="mailto:luciano.nicastro@inaf.it">L. Nicastro</a> &amp; <a style="color: #ccc;"  href="mailto:giorgio.calderone@inaf.it">G. Calderone</a></div> 
    </div>
  </div>

<!-- This is TODO -->
  <div class="app-info-div">
    <div id="app_info" style="padding: 6px;">e.g. App name</div>
  </div> 

</div>


<section class="page_top_tbar">

  <div id="file_io-div" class="div-hide">
    <button class="submit_grey" type="submit" onclick="openLoadDiv()" id="myBtn">
    <i style="color: #69c;"><svg class="icon-file-import" width="20" height="20"><use href="#file-import"></use></svg></i>Load file
    </button>

    <button id="viewbutton" class="simple_button" style="padding-right: 0.2em;" title="Retrieve full JSON data" onclick="saveJsonObj('gfit_data.json', chart_data)">
    <i style="color: #69c;"><svg class="icon-download" width="20" height="20"><use href="#download"></use></svg></i>JSON data
    </button>
    <span id="json_info" style="margin-left: 0.5em; font-weight: bold;">Data file info...</span>
  </div>

</section>


<div class="interface">

  <div id="myModal" class="modal modal-hide">
<!-- Modal content -->
    <div id="myModal_cont" class="modal-content">

	<div class="modal-header">
		<span class="close" title="Close">&times;</span>
		<h3 class="modal-header-text">GModelFitViewer file selector ...</h3>
	</div>

	<div id="modal-logdiv" class="modal-body">

		<div id="dropzone">
		  <div>
			Drag &amp; drop a GModelFit file here...
			<br />or<br />
			<label for="selfile" class="custom-file-select">
			<svg class="icon-search" width="20" height="20"><use href="#search"></use></svg><span class="ud-angle-l">Browse ...</span>
			</label>
			<input id="selfile" type="file" accept=".json" />
		  </div>
		</div>

		<progress value="0" max="100" id="progress-bar"></progress>
		<div id="f_status"></div>
	</div>

    </div>
  </div>

  <section style="margin-top: 0.5em;">
	<div id="p_title" class="inline">GModelFitViewer info here...</div>

  <div id="mod_sel-div" class="div-hide">
	<select id="p_selector" onchange="p_select()" class="dd-select" title="Select model"></select>

<!-- Add Prev / Next buttons -->
    <button id="prev_model" class="submit_grey" type="submit" onclick="p_select('prev')"> &lt; Prev </button>
    <button id="next_model" class="submit_grey" type="submit" onclick="p_select('next')"> Next &gt; </button>
  </div>
  </section>


<section id="plot-div" style="padding-bottom: 1rem;">
  <div id="chartdiv" style="resize: vertical;"></div>


  <div id="controls-div">

<!--
	<span class="box-cb" title="Toggle Y errors plot">
	  <input type="checkbox" id="y_err-cb" onclick="y_err_toggle()" /><label for="y_err-cb">Y err</label>
	</span>
-->
	<button class="box-cb" style="padding: 4px 4px 0 4px; color: #444; background: transparent;" title="Enter/exit Fullscreen Mode" onclick="toggleFullScreen('hdrdiv')">
	  <svg class="icon-expand" width="16" height="16"><use id="fullscreen-i" href="#expand"></use></svg>
	  </button>

	<span class="box-cb" title="Track and display cursor position coordinates">
	  <input type="checkbox" id="cursor-cb" onclick="cursor_toggle()" /><label for="cursor-cb">Track cursor</label>
	</span>
	<span class="box-cb" title="Toggle X lin/log scale">
	  <input type="checkbox" id="x_log-cb" onclick="x_linlog_toggle()" /><label for="x_log-cb">X log</label>
	</span>

	<span class="box-cb" title="Toggle Y lin/log scale">
	  <input type="checkbox" id="y_log-cb" onclick="y_linlog_toggle()" /><label for="y_log-cb">Y log</label>
	</span>

	<div id="range-selector-div">
	  <span class="label-range-in">X range</span><input name="xmin" type="text" title="X min" class="range-in" value="" onchange="xy_range_set()" />
	  <input name="xmax" type="text" title="X max" class="range-in" value="" onchange="xy_range_set()" />
	  <span class="label-range-in" style="margin-left: 1em;">Y range</span><input name="ymin" type="text" title="Y min" class="range-in" value="" onchange="xy_range_set()" />
	  <input name="ymax" type="text" title="Y max" class="range-in" value="" onchange="xy_range_set()" />

	  <button class="transp_button" style="padding: 4px 0 0 0; color: var(--success);" title="Replot with these ranges" onclick="xy_range_set()">
	  <svg class="icon-check-circle" width="18" height="18"><use href="#check-circle"></use></svg>
	  </button>
	  <button class="transp_button" style="padding: 4px 0 0 0; color: var(--danger);" title="Clear range input values" onclick="xy_range_reset()">
	  <svg class="icon-times" width="12" height="18"><use href="#times"></use></svg>
	  </button>
	</div>

  <div class="box-resid-in" id="box-resid-in">
    <div id="res_legenddiv"></div>

	<div style="display: inline-block; vertical-align: middle;" title="Set the highlighted resid. range">&pm;
	  <input type="number" style="width: 2.5rem;" min="1.0" max="30.0" step="0.1" name="n_sigma" id="n_sigma" value="3.0" onchange="n_sigma_update(this)" /> &sigma;
	</div>
  </div>

  </div> <!-- controls-div -->
</section>


<hr class="style-one"></hr>


<section id="fitlog_div" style="overflow: scroll;">

  <div id="fitres_div" class="out_table"></div>

<!-- The table selector -->
  <div id="fitlog_selector"></div>

<!-- The table viewing section -->
<div id="fitlog_tables_container">

  <div id="fitlog_tables"></div>

</div>

</div>

</section>


  <script>
    //var chart_data = JSON_DATA;
    var chart_data;
  </script>

<script src="test_data.js"></script>

<script type="text/javascript">
  var _version = '0.2.1', _date = '2024-03-21';
  document.querySelector('meta[name="version"]').setAttribute("content", _version);
  document.querySelector('meta[name="date"]').setAttribute("content", _date);
  document.getElementById('version-div').innerHTML = 'Version '+ _version;

// Initialize metadata and local variables
  var   n_sigma = 3,		// Highlight residuals region within this +/- sigma
	y_errplot = false,	// Y errors plot
	y_err_shade = false,	// Y errors shaded area
	x_logscale = false,	// X lin/log scale
	y_logscale = false,	// Y lin/log scale
	cur_track = false,	// Track cursor and display X, Y values
	am_anim = false,	// Animation theme ?
	x_range = {lin: {min: null, max: null}, log: {min: null, max: null}},  // lin/log X ranges
	y_range = {lin: {min: null, max: null}, log: {min: null, max: null}},  // lin/log Y ranges
	chart = {},	// The amchart object
	sdata = [],	// The data series to plot (with errors)
	serr = [],	// The Y errors shaded area series
	resid = [],	// The residuals
	cums2 = [],	// The cumulative Chi2
	aux = {},	// The metadata information read from the JSON file and more
	i_chmodel = -1, // Index of the Model data in the chart.series
	i_mod = -1,	// chart_data index of the Models
	i_mea = -1,	// chart_data index of the Measurements
	i_fit = -1,	// chart_data index of the FitStats
	vxAxis,		// X axis object
	valueAxis,	// Y axis object
	valueAxis2,	// The residuals right axis object
	valueAxis3,	// The cumulative Chi2 right axis object
	cur_container,	// The cursor Container
	curXY,		// The text Label in the cursor Container
	legend2,	// The second legend used for residuals
	range, range2,	// Used to highlight +/- N sigma residuals

	tab_extra = [],	// Additional GModelFit provided summary tables

	p_title = document.getElementById('p_title'),
	xyin_ranges = document.getElementById('range-selector-div').getElementsByTagName('input');


// A set of 19 colors + white + black
// grey, blue and darkblue removed and used by def. for the data, main reducer and residuals array
  var mycolors = [
        {'name':'Red', 'hex':'#e6194b', 'rgb':'(230, 25, 75)', 'rgba':'(230, 25, 75, 0.5)'},
        {'name':'Green', 'hex':'#3cb44b', 'rgb':'(60, 180, 75)', 'rgba':'(60, 180, 75, 0.5)'},
        {'name':'Purple', 'hex':'#911eb4', 'rgb':'(145, 30, 180)', 'rgba':'(145, 30, 180, 0.5)'},
        {'name':'Orange', 'hex':'#f0ad4e', 'rgb':'(240, 173, 78)', 'rgba':'(240, 143, 78, 0.5)'},
        {'name':'Magenta', 'hex':'#f032e6', 'rgb':'(240, 50, 230)', 'rgba':'(240, 50, 230, 0.5)'},
        {'name':'Teal', 'hex':'#008080', 'rgb':'(0, 128, 128)', 'rgba':'(0, 128, 128, 0.5)'},
        {'name':'Orange2', 'hex':'#ff7518', 'rgb':'(255, 117, 24)', 'rgba':'(255, 117, 24, 0.5)'},
        {'name':'Lavender', 'hex':'#e6beff', 'rgb':'(230, 190, 255)', 'rgba':'(230, 190, 255, 0.5)'},
        {'name':'Brown', 'hex':'#aa6e28', 'rgb':'(170, 110, 40)', 'rgba':'(170, 110, 40, 0.5)'},
        {'name':'Maroon', 'hex':'#800000', 'rgb':'(128, 0, 0)', 'rgba':'(128, 0, 0, 0.5)'},
        {'name':'Olive', 'hex':'#808000', 'rgb':'(128, 128, 0)', 'rgba':'(128, 128, 0, 0.5)'},
        {'name':'Coral', 'hex':'#ffd8b1', 'rgb':'(255, 215, 180)', 'rgba':'(255, 215, 180, 0.5)'},
        {'name':'Navy', 'hex':'#000080', 'rgb':'(0, 0, 128)', 'rgba':'(0, 0, 128, 0.5)'},

        {'name':'Pink2', 'hex':'#F0AAAA', 'rgb':'(240, 170, 170)', 'rgba':'(240, 170, 170, 0.5)'},
        {'name':'Mint2', 'hex':'#96E6B4', 'rgb':'(150, 230, 180)', 'rgba':'(150, 230, 180, 0.5)'},
        {'name':'Yellow', 'hex':'#FFD700', 'rgb':'(255, 215, 0)', 'rgba':'(255, 215, 0, 0.5)'},
        {'name':'Cyan2', 'hex':'#60C8E8', 'rgb':'(96, 200, 232)', 'rgba':'(96, 200, 232, 0.5)'},
        {'name':'Beige2', 'hex':'#E6D7B4', 'rgb':'(230, 215, 180)', 'rgba':'(230, 215, 180, 0.5)'},
        {'name':'Lime2', 'hex':'#C3E61E', 'rgb':'(195, 230, 30)', 'rgba':'(195, 230, 30, 0.5)'},

        {'name':'White', 'hex':'#FFFFFF', 'rgb':'(255, 255, 255)', 'rgba':'(255, 255, 255, 0.5)'},
        {'name':'Black', 'hex':'#000000', 'rgb':'(0, 0, 0)', 'rgba':'(0, 0, 0, 0.5)'}
  ], n_myc = 19,

// Data color
  dcolor = {'name':'Grey', 'hex':'#808080', 'rgb':'(128,128,128)', 'rgba':'(128,128,128, 0.5)'},

// Main reducer color
  mcolor = {'name':'Blue', 'hex':'#0082c8', 'rgb':'(0, 130, 200)', 'rgba':'(0, 130, 200, 0.5)'},

// Residuals color
  rcolor = {'name':'Darkblue', 'hex':'#386cb0', 'rgb':'(56,108,176)', 'rgba':'(56,108,176, 0.5)'};


// Manage URL passed parameters
  var c_imod = 0;		 // Currently plotted model index
  var interface_type = 'basic';	 // Default interface type

  if ( window.location.search !== '' ) {
    const urlParams = new URLSearchParams(window.location.search);

// Check if using amCharts animation theme (default false)
  if ( urlParams.has('animation') )
	am_anim = true;

// Check for the initial model to show (default 0)
  if ( urlParams.has('model') )
	c_imod = urlParams.get('model') - 1;

// Check for the interface type: basic (default), fileio, more TODO
  if ( urlParams.has('mode') )
	interface_type = urlParams.get('mode');
  }

  if ( interface_type == 'fileio' ) {
	document.getElementById('file_io-div').setAttribute('class', 'div-show-inline');
	document.getElementById('myModal').className = 'modal';
 }


// Detect exit fullscreen mode and show header

if (document.addEventListener)
{
  document.addEventListener('fullscreenchange', exitFSHandler, false);
  document.addEventListener('mozfullscreenchange', exitFSHandler, false);
  document.addEventListener('MSFullscreenChange', exitFSHandler, false);
  document.addEventListener('webkitfullscreenchange', exitFSHandler, false);
}

function exitFSHandler() {
  if (!document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement)
    document.getElementById('hdrdiv').classList.remove('div-hide');
    document.getElementById('fullscreen-i').setAttribute('href', '#expand');
}


// Perform a cumulative sum of an array

const cumulativeSum = (a) => {
  return a.map((sum => value => sum += value)(0));
}

const cumulativeSum2 = (a) => {
  return a.map((sum => value => sum += value*value)(0));
}


// Format numbers > 1000 adding the "," separator

const numberWithCommas = (x) => {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}


// Remove any ANSI code from string

const stripansi = (s) => {
  return s.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,'');
}


// Compute the number of fractional "significant" digits in sequential values from the given (~constant) step

const nfSignificant = (x) => {
  return Math.max((Math.abs(x) % 1).toPrecision(1).length - 2, 0);
}

// Format the parameters range at a given digits precision

const pRange = (low, high, np) => {
  if ( low === null && high === null )
    return '';

  if ( np === undefined )
    np = 4;

  if ( low === undefined || typeof low !== 'number' )
    v = '-Inf';
  else {
    v = low;
    if ( ! Number.isInteger(v) )
	v = +v.toPrecision(np);  // To number to remove trailing 0s
  }
  if ( high === undefined || typeof high !== 'number' )
    v += ':Inf';
  else {
    var v2 = high;
    if ( ! Number.isInteger(v2) )
	v2 = +v2.toPrecision(np);
    v += ':'+ v2;
  }
  return v;
}


// Hidden object?

function isHidden(e) {
	return (e.offsetParent === null)
}


// -- Open the file load modal div

function openLoadDiv() {
// Get the button that opens the modal
//var btn = document.getElementById("myBtn");

// When the user clicks the button, open the modal 
  showLoadDiv();

// Clean progress bar and load status message
  document.getElementById('progress-bar').value = 0;
  f_changeStatus('');

// Get the span element that hides the modal
  var span = document.getElementsByClassName('close')[0];

// When the user clicks on span (x), hide the modal
  span.onclick = function() {
	hideLoadDiv();
  }

// When the user clicks anywhere outside of the modal, hide it
  window.onclick = function(event) {
    var modal = document.getElementById('myModal');
    if ( event.target == modal )
	hideLoadDiv();
  }
}


// -- Show the modal div

function showLoadDiv() {
  var modal = document.getElementById('myModal');
  modal.className = 'modal modal-slidein';
}


// -- Hide the modal div

function hideLoadDiv() {
  var modal = document.getElementById('myModal');
  modal.className = 'modal modal-slideout';
}


//
// -- Files drop management

window.onload = function() {
	var dropzone = document.getElementById('dropzone');
	dropzone.ondragover = dropzone.ondragenter = function(event) {
		event.stopPropagation();
		event.preventDefault();
	}

	dropzone.ondrop = function(event) {
		event.stopPropagation();
		event.preventDefault();

		var filesArray = event.dataTransfer.files;
		for (i = 0; i < filesArray.length; i++)  // Actually here should limit to 1 file!
			processFile(filesArray[i]);
	}
}


//
// -- Files loading listening to "selfile" element change

document.getElementById('selfile').addEventListener('change', (e) => {
	const file = document.getElementById('selfile').files[0];
	if ( file )
	  processFile(file);
});


// A basic error handler for FileReader

const f_errorHandler = (e) => {
	f_changeStatus("Error: "+ e.target.error.name);
}


// Updates the value of the progress bar

const f_setProgress = (e) => {
// The target is the file reader
	const fr = e.target;
	const loadingPercentage = 100 * e.loaded / e.total;
	document.getElementById('progress-bar').value = loadingPercentage;
}

const f_changeStatus = (status) => {
	document.getElementById('f_status').innerHTML = status;
}


// Manage local file upload

const processFile = (file) => {
	const fr = new FileReader();
	fr.readAsText(file);
	fr.onprogress = f_setProgress;
	fr.onerror = f_errorHandler;
	fr.onabort = () => f_changeStatus('Start Loading');
	fr.onloadstart = () => f_changeStatus('Start Loading');
	fr.onload = f_loadedOk;
	fr.onloadend = () => fileInfo(file);

// At this point we can also perform some operations on the data asynchronously
}


// Display file info in the interface, considering data origin (local or web)

const fileInfo = (file) => {
	document.getElementById('progress-bar').value = 100;
	f_changeStatus('Loaded!');
	var fname, size_info = 'Loaded <strong>';
	if ( typeof file === 'object' ) {
		document.getElementById('json_info').innerHTML = file.name;
		size_info += numberWithCommas(chart.data.length) +'</strong> elements';
	} else if ( typeof file === 'string' ) {
		document.getElementById('json_info').innerHTML = file.split('/').reverse()[0];
		size_info += numberWithCommas(chart.dataSource.data.length) +'</strong> elements array';
	}
}


// Loading completed successfully; pass the data to chart

const f_loadedOk = (e) => {
	const fr = e.target;
	chart_data = JSON.parse(fr.result);
	c_imod = 0;  // Reset the model(s) index

	getauxinfo();

	p_select(0, true);
	hideLoadDiv();
}


//
// -- Toggle full-screen mode. Also toggle visibility of a user given div.

function toggleFullScreen(id_div) {
	var element = document.documentElement,
	    fs_i = document.getElementById('fullscreen-i'),
	    isFullscreen = document.webkitIsFullScreen || document.mozFullScreen || false;

	element.requestFullScreen = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || function () { return false; };
	document.cancelFullScreen = document.cancelFullScreen || document.webkitCancelFullScreen || document.mozCancelFullScreen || function () { return false; };

	if ( isFullscreen ) {
		fs_i.setAttribute('href', '#expand');
		document.cancelFullScreen();
	} else {
		fs_i.setAttribute('href', '#shrink');
		element.requestFullScreen();
	}

	if ( id_div !== undefined )  // Toggle the given div
	  document.getElementById(id_div).classList.toggle('div-hide');
}


//
// -- Extract and manage the metadata info

var getauxinfo = function() {  // TODO


  document.getElementById('app_info').innerHTML = '';


// Multiple models for the same "object" are allowed

  aux.n_p = 0;  // N models
  aux.n_d = 0;  // N measures
  aux.is_multimodel = false;
  aux.maincomp = [];  // The name of the main component buffer


// Clear indices arrays
  i_mod = -1, i_mea = -1, i_fit = -1;

  var cnames = [], desc, cdata, m, p, x_lab, y_lab, n_x, x_step, y_min=1e32, y_max=-1e32;

// Scan the input array of structures 
  for (var i = 0; i < chart_data.length; i++) {
	if ( chart_data[i]._structtype !== undefined )
		cdata = chart_data[i];
	else {
		cdata = chart_data[i][0];
		aux.is_multimodel = true;
	}

	if ( i_mod < 0 && cdata._structtype.indexOf('Model') >= 0 ) {
		i_mod = i;
		if ( aux.is_multimodel )
			aux.n_p = chart_data[i].length; 
		else
			aux.n_p++;  // Possible multiple models?
		n_x = cdata.domain.axis[0].length;

		if ( cdata.meta !== undefined )
			aux.meta = cdata.meta;

console.log('i_mod, maincomp:', i_mod, cdata.maincomp);

	} else if ( i_mea < 0 && cdata._structtype.indexOf('Measures') >= 0 ) {
		i_mea = i;
		if ( aux.is_multimodel )
			aux.n_d = chart_data[i].length;
		else
			aux.n_d++;
console.log('Measures:');
console.log('i_mea, aux.n_d:', i_mea, aux.n_d);

	} else if ( i_fit < 0 && cdata._structtype.indexOf('FitStats') >= 0 ) {
		i_fit = i;
	}
  }

// TODO
  if ( i_mod < 0 ) {
	alert('No Model found in your data.')
	return;
  }

  if ( chart_data[i_mod].extra !== undefined )
	tab_extra.push(chart_data[i_mod].extra[0]);
  else
	tab_extra.push({});



  aux.modinfo = [];
  aux.modinfo.length = 0;
  aux.datinfo = [];
  aux.datinfo.length = 0;


// Add loop also for the measures (TODO)
  for (var i = 0; i < aux.n_p; i++) {
    var n_reb = 1,
	x_scale = 1,
	y_scale = 1,
	x_rng = null,
	y_rng = null,
	x_lg = false,
	y_lg = false,
	x_lab = 'X label',
	y_lab = 'Y label',
	desc = '<span style="color: #69c; font-weight: bold;">',
	v_labs = ['values', 'uncerts'];

    if ( aux.is_multimodel ) {
	p = chart_data[i_mod][i];
	if ( i_mea >= 0 )
	  m = chart_data[i_mea][i];
    } else {
	p = chart_data[i_mod];
	if ( i_mea >= 0 )
	  m = chart_data[i_mea];
    }

    cnames = Object.keys(p.buffers);
    aux.maincomp.push(p.maincomp.substring(4));  // maincomp ~= _TS_main

// Labels in Measures 
    if ( i_mea >= 0 && m.labels !== undefined ) {
	v_labs = m.labels;
    }

    if ( p.meta !== undefined ) {
	if ( p.meta.rebin )
		n_reb = p.meta.rebin;
	if ( p.meta.xrange )
		x_rng = p.meta.xrange;
	if ( p.meta.yrange )
		y_rng = p.meta.yrange;
	if ( p.meta.xlog )
		x_lg = p.meta.xlog;
	if ( p.meta.ylog )
		y_lg = p.meta.ylog;
	if ( p.meta.xlabel ) {
		x_lab = p.meta.xlabel;
		if ( x_lab ) {
		  if ( p.meta.xscale !== null && p.meta.xscale !== 1 ) {
			var un = p.meta.xscale.toString().replace(/\+/,'');
			x_lab += ' (x '+ un +')'; 
		  }
		  if ( p.meta.xunit )
			x_lab += ' ('+ p.meta.xunit +')'; 
		}
	}

	if ( p.meta.ylabel ) {
		y_lab = p.meta.ylabel;
		if (  y_lab ) {
		  if ( p.meta.yscale !== null && p.meta.yscale !== 1 ) {
			var un = p.meta.yscale.toString().replace(/\+/,'');
			y_lab += ' (x '+ un +')'; 
		}
		  if ( p.meta.yunit )
			y_lab += ' ('+ p.meta.yunit +')';
		}
	}

	if ( p.meta.title )
		desc += p.meta.title;
	else
		desc += 'Model '+ i;

    }

    desc += '</span> &minus; rebin factor: '+ n_reb;


// Range check only on model components? TODO
    if ( y_rng ) {
	y_min = y_rng[0];
	y_max = y_rng[1];
    } else {
	for (var j = 0; j < cnames.length; j++) {
	  y_min = Math.min(y_min, Math.min(...(p.buffers[cnames[j]])));
	  y_max = Math.max(y_max, Math.max(...(p.buffers[cnames[j]])));
console.log('Model #, comp. #, y_min, y_max:', i, j, y_min, y_max);
	}
    }

// Scale Y axis for values < 0.01 or > 100
    var	log10scale2 = Math.floor(Math.log10(y_max));

    if ( log10scale2 < -2 || log10scale2 > 2 )
	y_scale = Math.pow(10, log10scale2);
    else
	log10scale2 = 0;

//console.log('log10scale2, y_scale', log10scale2, y_scale);

    x_step = Math.abs(p.domain.axis[0][1] - p.domain.axis[0][0]);

    aux.modinfo.push({
	title: desc,
	x_label: x_lab,
	y_label: y_lab,
	v_labels: v_labs,
	x_min: p.domain.axis[0][0],
	x_max: p.domain.axis[0][n_x - 1],
	x_step: x_step,
	x_scale: x_scale,
	y_scale: y_scale,
	x_range: x_rng,
	y_range: y_rng,
	x_log: x_lg, 
	y_log: y_lg, 
	//y_min: (y_min - y_rng*0.05) / y_scale,
	//y_max: (y_max + y_rng*0.05) / y_scale,
	y_min: y_min / y_scale,
	y_max: y_max / y_scale,
	nf_sig: nfSignificant(x_step),
	components: cnames,
	n_comps: cnames.length
    });
// Equidistance check (TODO)
    aux.modinfo[i].x_equi = Math.abs((aux.modinfo[i].x_max - aux.modinfo[i].x_min)/(n_x-1) - x_step) < 0.001;
  }  // end for i


// The model selector
  var  ss = document.getElementById('p_selector'),
	d = document.getElementById('mod_sel-div');
  ss.innerHTML = '';

// Create only if more than one model
  if ( aux.n_p < 2 )
    d.setAttribute('class', 'div-hide');
  else {
    d.setAttribute('class', 'div-show-inline');

// Append model select list
    for (var i = 0; i < aux.n_p; i++) {
	var lab, option = document.createElement('option');
	option.value = i;

	if ( aux.is_multimodel )
		p = chart_data[i_mod][i];
	else
		p = chart_data[i_mod];
	if ( p.meta !== undefined && p.meta.title !== undefined )
		lab = p.meta.title;
	else
		lab = "Model "+ i;
	option.text = (i+1).toString() +': '+ lab;
	ss.appendChild(option);
    }

    if ( c_imod == 0 )
	  document.getElementById('prev_model').classList.add('div-hide');
    else if ( c_imod == aux.n_p - 1 )
	  document.getElementById('next_model').classList.add('div-hide');
  }
  
  for (var i = 0; i < aux.n_d; i++) {
	aux.datinfo.push({
	  resid_visible: false,
	  resid_color: rcolor.hex}
	);
  }

  p_title.innerHTML = aux.modinfo[c_imod].title;
}


//
// -- From custom "model/measure" structures to default amchart data structure

var mydata2chart = function(isel) {
  if ( isel === undefined )
    isel = c_imod;

//console.log('mydata2chart isel:', isel);
  var p, m;
  if ( aux.is_multimodel ) {
	p = chart_data[i_mod][isel];
	if ( i_mea >= 0 )
	  m = chart_data[i_mea][isel];
  } else {
	p = chart_data[i_mod];
	if ( i_mea >= 0 )
	  m = chart_data[i_mea];
  }

  var x = p.domain.axis[0],
	cnames = aux.modinfo[isel].components,
	selred = aux.maincomp[isel],
	compevals = p.buffers[selred],
	fscale = Math.pow(10, aux.modinfo[isel].nf_sig),
	mydata = [], vals = {};


// X values rounded to the N sig. factional digits
  var cumchi2 = 0;
  for (var i = 0; i < x.length; i++) {
	vals = {};
	vals['comp_x'] = Math.round(x[i] * fscale) / fscale;
	vals['model'] = compevals[i] / aux.modinfo[isel].y_scale;

	if ( aux.n_d > 0 ) {
	  vals['x'] = Math.round(m.domain.axis[0][i] * fscale) / fscale;
	  //vals['model'] = chart_data[i_mod[isel]].model[i] / aux.modinfo[isel].y_scale;

	  vals['y'] = m.values[0][i] / aux.modinfo[isel].y_scale;
	  //vals['error'] = m.values[1][i];
	  //vals['resid'] = (vals['y'] - vals['model']) / vals['error'];
	  vals['resid'] = (m.values[0][i] - compevals[i]) / m.values[1][i];
	  cumchi2 += vals['resid']*vals['resid'];
	  vals['cums2'] = cumchi2;

	  vals['err_lo'] = (m.values[0][i] - m.values[1][i]) / aux.modinfo[isel].y_scale;
	  vals['err_up'] = (m.values[0][i] + m.values[1][i]) / aux.modinfo[isel].y_scale;
	}

	for (var j = 0; j < aux.modinfo[isel].n_comps; j++)  // Components
	  vals[cnames[j]] = p.buffers[cnames[j]][i] / aux.modinfo[isel].y_scale;

// Normalised Chi2
	vals['cums2'] /= (x.length - chart_data[i_fit].nfree);

	mydata.push(vals);
  }

  return mydata;
}


//
// -- Create series for the the main reducer of a model.
//    If xsc_series=true then use it also for the X window scrolling. 

function createMainReducer(isel, xsc_series=false) {
  if ( isel === undefined )
    isel = c_imod;

  var hs, p;
  if ( aux.is_multimodel )
	p = chart_data[i_mod][isel];
  else
	p = chart_data[i_mod];

  var selred = aux.maincomp[isel],
	compevals = p.buffers[selred];

console.log('Create "first" model:', selred);

  var series = chart.series.push(new am4charts.LineSeries());
  i_chmodel = chart.series.length - 1;
console.log('i_chmodel', i_chmodel);
  //series.dataFields.valueX = 'x';
  series.dataFields.valueX = 'comp_x';
  series.dataFields.valueY = 'model';

  series.name = 'Model';
  series.legendSettings.labelText = 'Model [#fff]______[/]';
  series.strokeWidth = 2;
  series.showOnInit = false;

  series.stroke = mcolor.hex;
  series.fill = mcolor.hex;


// Highlight when cursor on legend item
  hs = series.segments.template.states.create("hover");
  hs.properties.strokeWidth = 5;

  if ( xsc_series !== undefined && xsc_series == true )
    chart.scrollbarX.series.push(series);
}


//
// -- The data series

function createDataSeries(isel) {
  if ( isel === undefined )
    isel = c_imod;

// No data, just the model. Create and return.
  if ( aux.n_d == 0 ) {
    createMainReducer(isel, true);
    document.getElementById('box-resid-in').style.visibility = 'hidden';
    return;
  }

  var hs;
  sdata = [];
  sdata = chart.series.push(new am4charts.LineSeries());
  sdata.dataFields.valueX = 'x';
  sdata.dataFields.valueY = 'y';
  sdata.name = 'data';  // chart_data.meta.data.label;
  sdata.legendSettings.labelText = 'Data';
  sdata.strokeWidth = 2;
  sdata.showOnInit = false;

// Auto selected color
  sdata.stroke = dcolor.hex;
  sdata.fill = dcolor.hex;
 
// The shaded errors range
  serr = chart.series.push(new am4charts.LineSeries());
  serr.dataFields.valueX = 'x';
  serr.dataFields.openValueY = 'err_lo';
  serr.dataFields.valueY = 'err_up';
  serr.name = 'uncert';
  serr.legendSettings.labelText = 'Uncert.';
  serr.fillOpacity = 0.3;
  serr.fill = sdata.fill;
  serr.stroke = am4core.color("#ffffff00");  // White (transparent) top line
  serr.visible = false;  // Hidden by default
  serr.showOnInit = false;

// Highlight when cursor on legend item
  hs = sdata.segments.template.states.create("hover");
  hs.properties.strokeWidth = 5;


  chart.scrollbarX.series.push(sdata);


// -- Main Reducer always first (and before residuals and components)

  createMainReducer(isel);


// -- Residuals

  document.getElementById('box-resid-in').style.visibility = 'visible';

  resid = chart.series.push(new am4charts.LineSeries());
  resid.dataFields.valueX = 'x';
  resid.dataFields.valueY = 'resid';
  resid.name = 'Residuals';  // chart_data.data.meta.resid_label;
  resid.yAxis = valueAxis2;
  resid.strokeWidth = 1;
  //var circleBullet = resid.bullets.push(new am4charts.CircleBullet());
  //circleBullet.circle.radius = 2;
  //resid.minBulletDistance = 5;
  //var bullet = resid.bullets.push(new am4charts.Bullet());
  //var square = bullet.createChild(am4core.Rectangle);
  //square.width = 2;
  //square.height = 2;
  //square.horizontalCenter = "middle";
  //square.verticalCenter = "middle";
  resid.hiddenInLegend = true;  // Not in the default legend
  resid.showOnInit = false;

// - Cumulative Chi2

  cums2 = chart.series.push(new am4charts.LineSeries());
  cums2.dataFields.valueX = 'x';
  cums2.dataFields.valueY = 'cums2';
  cums2.name = 'CumulativeChi2';
  cums2.yAxis = valueAxis3;
  cums2.strokeWidth = 2;
  cums2.hiddenInLegend = true;  // Not in the default legend
  cums2.showOnInit = false;
  cums2.stroke = am4core.color("#990000");

// Visible?
  sdata.resid_visible = aux.datinfo[isel].resid_visible;

  if ( sdata.resid_visible ) {
	range.grid.strokeOpacity = 0.5;
	range2.axisFill.fillOpacity = 0.1;
	//valueAxis.renderer.grid.template.strokeOpacity = 0;
	valueAxis2.renderer.ticks.template.strokeOpacity = 1;
	valueAxis3.renderer.ticks.template.strokeOpacity = 1;
  } else {
	valueAxis2.setVisibility(false);
	valueAxis2.cursorTooltipEnabled = false;
	valueAxis3.setVisibility(false);
	resid.setVisibility(false);
	cums2.setVisibility(false);

	range.grid.strokeOpacity = 0;
	range2.axisFill.fillOpacity = 0; 
  }

  
// User selected color?
  if ( aux.datinfo[isel].resid_color !== 'auto' ) {
	resid.stroke = aux.datinfo[isel].resid_color;
	resid.fill = aux.datinfo[isel].resid_color;
  } else {
	resid.stroke = rcolor.hex;
	resid.fill = rcolor.hex;
  }

  if ( legend2.data.length == 0 )
	legend2.data.push({name: resid.name + ' (\u03C3)', fill: resid.fill, visible: sdata.resid_visible});

  legend2.tooltipText = 'Show/hide residuals';
  legend2.tooltip.background.opacity = 0.7;
  legend2.tooltip.pointerOrientation = 'right';
  legend2.tooltip.dx = -56;

  var marker = legend2.markers.template.children.getIndex(0);
  legend2.useDefaultMarker = true;
  marker.width = 16;
  marker.height = 16;
  marker.strokeWidth = 2;
  marker.strokeOpacity = 1;
  marker.stroke = am4core.color("#ccc");


// Highlight when cursor on legend item
  legend2.itemContainers.template.events.on("over", function(ev) {
	resid.strokeWidth = 3;
  });

  legend2.itemContainers.template.events.on("out", function(ev) {
	resid.strokeWidth = 2;
  });


// Toggle residuals visibility in legend2.
// Note that hide() and show() causes a full range replot!
  legend2.itemContainers.template.events.on("hit", function(ev) {
//var field = ev.target.dataItem.dataContext, name = field.name;
    if ( resid.visible ) {
	range.grid.strokeOpacity = 0;
	range2.axisFill.fillOpacity = 0;
	//valueAxis2.renderer.ticks.template.strokeOpacity = 0;
	valueAxis2.setVisibility(false);
//valueAxis2.cursorTooltipEnabled = false;

	//valueAxis3.renderer.ticks.template.strokeOpacity = 0;
	valueAxis3.setVisibility(false);

	resid.hide();
	cums2.hide();

// Show data and model series
	valueAxis.setVisibility(true);
	sdata.show();
	chart.series.values[i_chmodel].show();

    } else {
	n_sigma = +document.getElementById('n_sigma').value;
	range2.value = -n_sigma;
	range2.endValue = n_sigma;
	range.grid.strokeOpacity = 0.5;
	range2.axisFill.fillOpacity = 0.1;
	//valueAxis2.renderer.ticks.template.strokeOpacity = 1;
	valueAxis2.setVisibility(true);

	//valueAxis3.renderer.ticks.template.strokeOpacity = 1;
	valueAxis3.setVisibility(true);

	valueAxis2.minDefined = -n_sigma - 1;
	valueAxis2.maxDefined = n_sigma + 1;
	setTimeout(function() {
		valueAxis2.zoomToValues(-n_sigma - 1, n_sigma + 1);
//valueAxis2.cursorTooltipEnabled = true;
	}, 200);

// Hide all series but resid and cum2s
	valueAxis.setVisibility(false);
	for (var i = 0; i < chart.series.length; i++ ) {
		if ( chart.series.values[i].name !== resid.name && chart.series.values[i].name !== cums2.name &&
		     chart.series.values[i].visible )
			chart.series.values[i].hide();
	}

	resid.show();
	cums2.show();
    }
    sdata.resid_visible = ! sdata.resid_visible;

console.log('zoom to:', x_range.lin.min, x_range.lin.max);
    setTimeout(function() {
	if ( x_logscale ) {
	  if ( vxAxis.min !== x_range.log.min || vxAxis.max !== x_range.log.max )
		vxAxis.zoomToValues(x_range.log.min, x_range.log.max);
	} else {
	  if ( vxAxis.min !== x_range.lin.min || vxAxis.max !== x_range.lin.max )
		vxAxis.zoomToValues(x_range.lin.min, x_range.lin.max);
	}
    }, 100);
  });  // legend2


// Highlight when cursor on legend item
//hs = resid.segments.template.states.create("hover");
//hs.properties.strokeWidth = 5;
}


//
// -- Create series for each component of a model

function createCompSeries(isel) {
  if ( isel === undefined )
    isel = c_imod;

  var p;
  if ( aux.is_multimodel )
	p = chart_data[i_mod][isel];
  else
	p = chart_data[i_mod];

  var series, cname, compevals, hs, icol = 0;

  vxAxis.title.text = aux.modinfo[isel].x_label;
  valueAxis.title.text = aux.modinfo[isel].y_label;

// -- Components
  for (var i = 0; i < aux.modinfo[isel].n_comps; i++) {  // Components in a model
	cname = aux.modinfo[isel].components[i];
	compevals = p.buffers[cname]; //  p.compevals[cname];
console.log('Create component:', cname);
    
	series = chart.series.push(new am4charts.LineSeries());
	series.dataFields.valueX = 'comp_x';
	series.dataFields.valueY = cname;

	series.name = cname;
	series.strokeWidth = 2;
	series.showOnInit = false;

	series.stroke = mycolors[icol % n_myc].hex;
	series.fill = mycolors[icol % n_myc].hex;
console.log('  color:', mycolors[icol % n_myc].name, mycolors[icol % n_myc].hex);
	icol++;

	//if ( !compevals.meta.default_visible )  // Component to hide?
	series.visible = false;

// Highlight when cursor on legend item
	hs = series.segments.template.states.create("hover");
	hs.properties.strokeWidth = 5;
  }  // end for i
}


//
// -- Cursor creation and management

function createCursor() {
  chart.cursor = new am4charts.XYCursor();
  chart.cursor.xAxis = vxAxis;
  chart.cursor.yAxis = valueAxis;
  chart.cursor.behavior = 'zoomXY';

// Monitor cursor position
  var cursorPosition = {
	x: null,
	y: null
  };

  chart.cursor.events.on("cursorpositionchanged", function(ev) {
	var xAxis = ev.target.chart.xAxes.getIndex(0);
	var yAxis = ev.target.chart.yAxes.getIndex(0);
	cursorPosition.x = xAxis.positionToValue(xAxis.toAxisPosition(ev.target.xPosition));
	cursorPosition.y = yAxis.positionToValue(yAxis.toAxisPosition(ev.target.yPosition));
//
	if ( cur_track )
	  curXY.text = '[black]X:[/] '+ cursorPosition.x.toPrecision(6) +'\xa0\xa0\ [black]Y:[/] '+ cursorPosition.y.toPrecision(6);
  });

  chart.plotContainer.events.on("hit", function(ev) {
console.log(cursorPosition);
	curXY.text = '[black]X:[/] '+ cursorPosition.x.toPrecision(6) +'\xa0\xa0\ [black]Y:[/] '+ cursorPosition.y.toPrecision(6);
  });


// Need to manage manually the Y zoom (animation issue?)
  chart.cursor.events.on("zoomended", function(ev) {
    var x_min = vxAxis.min + vxAxis.start * (vxAxis.max - vxAxis.min),
	x_max = vxAxis.min + vxAxis.end * (vxAxis.max - vxAxis.min),
	y_min = valueAxis.min + valueAxis.start * (valueAxis.max - valueAxis.min),
	y_max = valueAxis.min + valueAxis.end * (valueAxis.max - valueAxis.min);

console.log("X cursor selected from "+ x_min +" to "+ x_max);
console.log("Y cursor selected from "+ y_min +" to "+ y_max);
	x_range.lin.min = x_min;
	x_range.lin.max = x_max;
	(x_min > 0) ? x_range.log.min = x_min : x_range.log.min = 1e-4;  // TODO
	x_range.log.max = x_max;

	y_range.lin.min = y_min;
	y_range.lin.max = y_max;

	(y_min > 0) ? y_range.log.min = y_min : y_range.log.min = 1e-4;  // TODO
	y_range.log.max = y_max;

	xyin_ranges.xmin.value = x_min.toPrecision(4);
	xyin_ranges.xmax.value = x_max.toPrecision(4);
	xyin_ranges.ymin.value = y_min.toPrecision(4);
	xyin_ranges.ymax.value = y_max.toPrecision(4);

	if ( am_anim ) {
// If animation is on, a delay is necessary to have the Y zoom
	  setTimeout(function() {
		valueAxis.zoomToValues(y_min, y_max);
	  }, 100);
	}
  });

}


//
// -- Select current model from multi-models list

function p_select(isel, new_file) {
  var ip = document.getElementById('p_selector').value;

  if ( isel === undefined )
	isel = ip;
  else {
	if ( isel === 'prev' )
	  isel = +ip - 1;
	else if ( isel === 'next' )
	  isel = +ip + 1;

	document.getElementById('p_selector').value = isel;
  }

  if ( isel == 0 ) {
	document.getElementById('prev_model').classList.add('div-hide');
	document.getElementById('next_model').classList.remove('div-hide');
  } else if ( isel == aux.n_p - 1 ) {
	document.getElementById('prev_model').classList.remove('div-hide');
	document.getElementById('next_model').classList.add('div-hide');
  } else {
	document.getElementById('prev_model').classList.remove('div-hide');
	document.getElementById('next_model').classList.remove('div-hide');
  }

  if ( new_file === undefined )
	new_file = false;

// First clear all series
  chart.series.each(function() {
	chart.series.removeIndex( 0 );
    //chart.series.removeIndex( chart.series.indexOf(s) );
  });

  c_imod = isel;  // Set index of selected model

  chart.data = mydata2chart(isel);
  createDataSeries();
  createCompSeries();

// Change plot labels
  document.getElementById('p_title').innerHTML = aux.modinfo[c_imod].title;
}


//
// -- amChart code

am4core.ready(function() {

  if ( am_anim )
	am4core.useTheme(am4themes_animated);

  chart = am4core.create('chartdiv', am4charts.XYChart);

// Disable logo ?
//chart.logo.disabled = true;

// Increase contrast by taking evey second color
  //chart.colors.step = 2;

// Theme animated
  if ( chart_data !== undefined ) {
    if (interface_type == 'fileio' )
	document.getElementById('myModal').className = 'modal modal-hide';

// Read metadata info
    getauxinfo();
    chart.data = mydata2chart(c_imod); 

    document.getElementById('json_info').innerHTML = aux.n_spe +' data. Current: '+
	(aux.modinfo[0].n_comps) +' components fit.';

// Highlight button for current model
    if ( aux.n_p > 1 )
	document.getElementById('p_selector').value = c_imod;

  } else {
    for (var j = 0; j < 2 * Math.PI; j += 0.1)
	chart.data.push({"lambda": parseInt(1000 + j*1500), "y": Math.sin(j)});

// Open the file load div (if I/O mode interface)
    if ( interface_type == 'fileio' )
	openLoadDiv();
  }


// Create X axis

// Additional X axis as ValueAxis
  vxAxis = chart.xAxes.push(new am4charts.ValueAxis());
  vxAxis.dataFields.valueX = 'x';
  vxAxis.renderer.grid.template.stroke = am4core.color("#ddd");
  vxAxis.renderer.grid.template.strokeOpacity = 1;
  vxAxis.min = aux.modinfo[c_imod].x_min;
  vxAxis.max = aux.modinfo[c_imod].x_max;
  vxAxis.strictMinMax = true;  // This causes issue with the log plot

// No cursor Tooltip for ValueAxis
//vxAxis.cursorTooltipEnabled = true;
//vxAxis.precision = 4;

//vxAxis.renderer.grid.template.dx=5;
//vxAxis.renderer.labels.template.dx=5;
//--


// Create main Y-values axis
  valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
  valueAxis.title.fontSize = 18;
  valueAxis.renderer.grid.template.stroke = am4core.color("#ddd");
  valueAxis.renderer.grid.template.strokeOpacity = 1;

  //valueAxis.renderer.minWidth = 60;

  valueAxis.strictMinMax = true;
//valueAxis.precision = 4;

// Eventually the second Y-value axis (for residuals). Note that it is only checked here!

// The cumulative Chi2
  valueAxis3 = chart.yAxes.push(new am4charts.ValueAxis());
  valueAxis3.strictMinMax = true;
  valueAxis3.title.text = 'Cumulative sum of squared residuals';
  valueAxis3.renderer.opposite = true;  // Right side
  valueAxis3.renderer.line.strokeOpacity = 1;
  valueAxis3.renderer.line.strokeWidth = 2;
  valueAxis3.renderer.labels.template.fill=am4core.color("#990000")

  valueAxis3.title.fontSize = 18;
  valueAxis3.renderer.grid.template.disabled = true;  // No grid

  //valueAxis3.renderer.ticks.template.disabled = false;
  //valueAxis3.renderer.ticks.template.strokeOpacity = 0;
  //valueAxis3.renderer.ticks.template.stroke = am4core.color("#990000");
  //valueAxis3.renderer.ticks.template.strokeWidth = 2;
  //valueAxis3.renderer.ticks.template.length = 8;  // Outward

  //valueAxis3.renderer.minWidth = 60;

  valueAxis2 = chart.yAxes.push(new am4charts.ValueAxis());
  valueAxis2.strictMinMax = true;
  valueAxis2.title.text = 'Normalized residuals (\u03C3)';

  valueAxis2.renderer.line.strokeOpacity = 1;
  valueAxis2.renderer.line.strokeWidth = 2;
  valueAxis2.renderer.line.stroke = am4core.color("#495C43");
  valueAxis2.title.fontSize = 18;
  valueAxis2.renderer.grid.template.disabled = true;  // No grid

  //valueAxis2.renderer.minWidth = 60;
 
// Configure ticks
  //valueAxis2.renderer.ticks.template.disabled = false;
  //valueAxis2.renderer.ticks.template.strokeOpacity = 0;
  //valueAxis2.renderer.ticks.template.stroke = am4core.color("#495C43");
  //valueAxis2.renderer.ticks.template.strokeWidth = 2;
  //valueAxis2.renderer.ticks.template.length = -10;  // Inward


// The +/- N sigma shaded region with the (dashed) 0 level. Visibility management is TODO.
  // 0 level dashed line
  range = valueAxis2.axisRanges.create();
  range.value = 0;
  range.grid.stroke = am4core.color("#396478");
  range.grid.strokeWidth = 2;
  range.grid.strokeDasharray = "4";

  // +/- N sigma shaded area with invisible strokes
  range2 = valueAxis2.axisRanges.create();
  range2.grid.stroke = am4core.color("#ff6478");
  range2.value = -n_sigma;
  range2.endValue = n_sigma;
  range2.grid.strokeOpacity = 0;


// Scrollbar disabling labels and grid
  chart.scrollbarX = new am4charts.XYChartScrollbar();

// Create container to hold cursor X, Y values
  cur_container = chart.plotContainer.createChild(am4core.Container);
  //cur_container.width = am4core.percent(50);
  cur_container.width = 240;
  cur_container.height = 36;
  cur_container.x = am4core.percent(50);
  cur_container.align = 'center';
  cur_container.y = 0;
  cur_container.padding(10, 10, 10, 10);
  cur_container.background.fill = am4core.color('#aaa');
  cur_container.background.fillOpacity = 0;

  curXY = cur_container.createChild(am4core.Label);
  curXY.id = 'cursor';
  curXY.text = '';
  curXY.minWidth = 50;
  curXY.align = 'center';
  curXY.marginRight = 6;
  curXY.fontWeight = 'bolder';
  curXY.fill = am4core.color('#396478');

// Monitor X axis zoom (TODO)
//vxAxis.events.on("startendchanged", vxAxisChanged);
//chart.scrollbarX.events.on("selectionextremeschanged", scrollAxisChanged);

  chart.scrollbarX.events.on("rangechanged", scrollAxisChanged);


// This does not work in log scale (TODO) !

  function scrollAxisChanged(ev) {
    var x_min = vxAxis.min + vxAxis.start * (vxAxis.max - vxAxis.min),
	x_max = vxAxis.min + vxAxis.end * (vxAxis.max - vxAxis.min);
        //var x_min = ev.target.minZoomed;
        //var x_max = ev.target.maxZoomed;
	//-var xaxis = chart.xAxes.getIndex(0);
	//-var x_min = xaxis.positionToValue(ev.target.range.start);
	//-var x_max = xaxis.positionToValue(ev.target.range.end);
console.log("New vxAxis range: " + x_min + " -- " + x_max);
	xyin_ranges.xmin.value = x_min.toPrecision(4);
	xyin_ranges.xmax.value = x_max.toPrecision(4);
	x_range.lin.min = x_min;
	x_range.lin.max = x_max;
	(x_min > 1e-4) ? x_range.log.min = x_min : x_range.log.min = 1e-4;  // TODO
	x_range.log.max = x_max;
  }



// Legends

  var legendContainer = am4core.create("res_legenddiv", am4core.Container);
  legendContainer.width = am4core.percent(100);
  //legendContainer.height = am4core.percent(100);

  legend2 = new am4charts.Legend();
  legend2.parent = legendContainer;
  legend2.marginTop = 20;
  legend2.marginLeft = 0;
  legend2.labels.template.text = "[bold]{name}[/]";

  chart.legend = new am4charts.Legend();
  chart.legend.marginTop = 20;
  chart.legend.labels.template.text = "[bold]{name}[/]";
  chart.legend.useDefaultMarker = true;

  chart.legend.itemContainers.template.togglable = false;  // Disable default

  var marker = chart.legend.markers.template.children.getIndex(0);

  marker.cornerRadius(8, 8, 8, 8);
  marker.adapter.add("cornerRadiusTopLeft", radiusAdapter);
  marker.adapter.add("cornerRadiusTopRight", radiusAdapter);
  marker.adapter.add("cornerRadiusBottomLeft", radiusAdapter);
  marker.adapter.add("cornerRadiusBottomRight", radiusAdapter);

  chart.legend.itemContainers.template.adapter.add("tooltipText",  ttAdapter);
  chart.legend.tooltip.background.opacity = 0.7;
  chart.legend.tooltip.dy = -20;

  marker.width = 16;
  marker.height = 16;
  marker.strokeWidth = 2;
  marker.strokeOpacity = 1;
  marker.stroke = am4core.color("#ccc");

function radiusAdapter(radius, target) {
  if (!target.dataItem) {
	return radius;
  }

  if ( target.dataItem.name == 'uncert' )
	return 3;
  else
	return radius;
}

function ttAdapter(tooltip, target) {
  if ( target.dataItem.name == 'uncert' )
	return 'Show/hide data uncertainties shade area';
  else
	return '';
}


// Values background (unused)
  var lt = chart.legend.valueLabels.template;
  lt.background.fill = am4core.color("#efefef");
  lt.background.fillOpacity = 1;
  lt.minWidth = lt.width * 1.2;  // 20% increase. This fixes width change at run time

  chart.legend.itemContainers.template.events.on("over", function(event) {
    var segments = event.target.dataItem.dataContext.segments;
    segments.each(function(segment) {
      segment.isHover = true;
    });
  });

  chart.legend.itemContainers.template.events.on("out", function(event) {
    var segments = event.target.dataItem.dataContext.segments;
    segments.each(function(segment) {
      segment.isHover = false;
    });
  });


// Manage the click on the legend labels, in particular "residuals"
  chart.legend.itemContainers.template.events.on("hit", function(ev) {
    var field = ev.target.dataItem.dataContext,
	name = ev.target.dataItem.name,
	index = ev.target.dataItem.index;
//console.log('Clicked:', name);
//console.log('Index:', ev.target.dataItem.index);
//console.log( 'visible', field.visible );

    if ( ! field.visible ) {
	if ( am_anim )
	  field.show(300);
	else
	  field.visible = true;
	field.strokeOpacity = 1;
//chart.legend.markers.getIndex(index).fillOpacity = 1;
//chart.legend.labels.getIndex(index).fill = am4core.color("#333");
//ev.target.dataItem.marker.fillOpacity = 1;
//ev.target.dataItem.label.fill = am4core.color("#333");
    } else {
	if ( am_anim )
	  field.hide(300);
	else
	  field.visible = false;
	//field.strokeOpacity = 0;
//chart.legend.markers.getIndex(index).fillOpacity = 0.1;
//chart.legend.labels.getIndex(index).fill = am4core.color("#999");
//ev.target.dataItem.marker.fillOpacity = 0.1;
//ev.target.dataItem.label.fill = am4core.color("#999");
    }

  });


// Set up number format
//chart.numberFormatter.numberFormat = "#,###.000";

// The export menu
  chart.exporting.menu = new am4core.ExportMenu();

  chart.exporting.timeoutDelay = 5000;  // Wait 5 s before warning

  chart.zoomOutButton.disabled = true;  // Disable zoom out button

// The annotations tool
  var annotation = chart.plugins.push(new am4plugins_annotation.Annotation());

// The series
  createDataSeries();
  createCompSeries();


// It seems this only works on first call (see set_x_range)
  //vxAxis.zoomToValues(aux.modinfo[c_imod].x_min, aux.modinfo[c_imod].x_max + aux.modinfo[c_imod].x_step / 2);

// -- On data validation reset X / Y range for lin/log scale and clear input fields.
// -- Also disable scrollbar labels and grid. Need to be done after series push.

  chart.events.on('datavalidated', function(e) {

	var scrollAxis = chart.scrollbarX.scrollbarChart.xAxes.getIndex(0);
	scrollAxis.renderer.labels.template.disabled = true;
	scrollAxis.renderer.grid.template.disabled = true;

// Use exponential notation for Y axis labels when small values are involved
	valueAxis.numberFormatter = new am4core.NumberFormatter();
	if ( aux.modinfo[c_imod].y_max < 0.1 )
	  valueAxis.numberFormatter.numberFormat = '#.00e';
	else
	  valueAxis.numberFormatter.numberFormat = "#,###.#####";

//document.getElementById('y_err-cb').checked = false;
//document.getElementById('y_err_shade-cb').checked = false;
	document.getElementById('cursor-cb').checked = false;
	document.getElementById('x_log-cb').checked = false;
	document.getElementById('y_log-cb').checked = false;
	vxAxis.logarithmic = false;
	valueAxis.logarithmic = false;

	if ( legend2.data.length !== 0 ) {
	  legend2.data[0].visible = sdata.resid_visible;
	  valueAxis2.renderer.ticks.template.strokeOpacity = 0;
	}

//var marker = legend2.markers.template.children.getIndex(0);
//marker.setState(marker.defaultState);

//errorBullet.hide();
//valueAxis.precision = 0;
	set_x_range();
	set_y_range();
	xy_rangein_reset();  // Clear manual range input fields

// Fit log tables are ri-created by createFitLogTabs for each model
	createFitLogTabs();  // The fit log tables
  });


// Cursor created once the plot is finished to get the ranges correct
  chart.events.on('ready', function() {
	createCursor();

  });

});  // end am4core.ready()


//
// -- Update residuals Nsigma shaded range and axis zoom

function n_sigma_update(e) {
  if ( ! resid.visible )
	return;

  n_sigma = +e.value;
  range2.value = -n_sigma;
  range2.endValue = n_sigma;
  valueAxis2.minDefined = -n_sigma - 1;
  valueAxis2.maxDefined = n_sigma + 1;

// Also zoom the axis range
  setTimeout(function() {
	valueAxis2.zoomToValues(-n_sigma - 1, n_sigma + 1);
  }, 200);
}


//
// -- The shaded error range area (unused)
/*
function y_err_shade_toggle() {
  y_err_shade = document.getElementById('y_err_shade-cb').checked;

  if ( y_err_shade )
	serr.show();
  else
	serr.hide();
}
*/


//
// -- Set initial X range

function set_x_range(from_rangein) {
// This is not set immediately and causes problems to the zoom below!
  var x_min, x_max;
  if ( from_rangein !== undefined && from_rangein == true ) {
	x_min = parseFloat(xyin_ranges.xmin.value !== '' ? xyin_ranges.xmin.value : vxAxis.min);
	x_max = parseFloat(xyin_ranges.xmax.value !== '' ? xyin_ranges.xmax.value : vxAxis.max);

	vxAxis.zoomToValues(x_min, x_max);
  } else if ( aux.modinfo[c_imod].x_range ) {  // User defined X range
console.log('Set x_range:', aux.modinfo[c_imod].x_range);
	x_min = aux.modinfo[c_imod].x_range[0];
	x_max = aux.modinfo[c_imod].x_range[1];
	vxAxis.min = x_min;
	vxAxis.max = x_max;
  } else {
	x_min = aux.modinfo[c_imod].x_min;
	x_max = aux.modinfo[c_imod].x_max;
	vxAxis.min = x_min;
	vxAxis.max = x_max;
  }

// For some reason here we need a value higher than xAxis.max to force alignement
//  vxAxis.zoomToValues(aux.modinfo[c_imod].x_min, aux.modinfo[c_imod].x_max + aux.modinfo[c_imod].x_step / 2);

  x_range.lin.min = x_min;
  x_range.lin.max = x_max;
  (x_min > 1e-4) ? x_range.log.min = x_min : x_range.log.min = 1e-4;  // TODO
  x_range.log.max = x_max;

  if ( aux.modinfo[c_imod].x_log ) {  // User defined X log scale
console.log('Set x_log:', aux.modinfo[c_imod].x_log);
	document.getElementById('x_log-cb').checked = true;
  }
}


//
// -- Set initial Y range

function set_y_range() {
  var y_min, y_max;

  if ( aux.modinfo[c_imod].y_range ) {  // User defined Y range
console.log('Set y_range:', aux.modinfo[c_imod].y_range);
	y_min = aux.modinfo[c_imod].y_range[0];
	y_max = aux.modinfo[c_imod].y_range[1];
  } else {
	y_min = aux.modinfo[c_imod].y_min;
	y_max = aux.modinfo[c_imod].y_max;

// Then data, and then the +/- error, if exist
	if ( aux.n_d > 0 ) {
	  var err_lo = chart.data.map(({ err_lo }) => err_lo),
		err_up = chart.data.map(({ err_up }) => err_up);

	  y_min = Math.min(y_min, Math.min(...(err_lo)));
	  y_max = Math.max(y_max, Math.max(...(err_up)));
	}
  }

console.log('Y range set to:', y_min, y_max);
  y_range.lin.min = y_min;
  y_range.lin.max = y_max;
  (y_min > 1e-4) ? y_range.log.min = y_min : y_range.log.min = 1e-4;  // TODO
  y_range.log.max = y_max;

  if ( aux.modinfo[c_imod].y_log ) {  // User defined Y log scale
console.log('Set y_log:', aux.modinfo[c_imod].y_log);
	document.getElementById('y_log-cb').checked = true;
  }

// Needed at start
  valueAxis.min = y_range.lin.min;
  valueAxis.max = y_range.lin.max;
  setTimeout(function() {
	y_linlog_toggle();
  }, 300);
}


//
// -- Toggle Y data error plot (unused)
/*
function y_err_toggle() {
  y_errplot = document.getElementById('y_err-cb').checked;

  if ( y_errplot )
	errorBullet.show();
  else
	errorBullet.hide();

}
*/


// -- Track and display cursor X, Y position 

function cursor_toggle() {
  cur_track = document.getElementById('cursor-cb').checked;
  curXY.text = '';

  if ( cur_track )
	cur_container.background.fillOpacity = 0.1;
  else
	cur_container.background.fillOpacity = 0;

}


//
// -- Toggle linear / logarithmic X / Y scale

function x_linlog_toggle() {
  x_logscale = document.getElementById('x_log-cb').checked;

  if ( x_logscale ) {   // From lin to log
	vxAxis.logarithmic = true;
	if ( vxAxis.min <= 0 )
	  vxAxis.min = x_range.log.min;
//vxAxis.max = x_range.log.max;
	if ( x_range.log.max == x_range.lin.max )
	  x_range.log.max *= 1.001;
	setTimeout(function() {
	  vxAxis.zoomToValues(x_range.log.min, x_range.log.max);
	}, 200);

  } else {  // From log to lin
//vxAxis.min = x_range.lin.min;
//vxAxis.max = x_range.lin.max;
	vxAxis.logarithmic = false;
	if ( x_range.log.max == x_range.lin.max )
	  x_range.lin.max *= 1.001;
	vxAxis.zoomToValues(x_range.lin.min, x_range.lin.max);
  }

}


function y_linlog_toggle() {
  y_logscale = document.getElementById('y_log-cb').checked;
  var c_ymax;

  if ( y_logscale ) {  // From lin to log
	valueAxis.min = y_range.log.min;
	valueAxis.logarithmic = true;
	//valueAxis.strictMinMax = true;
	c_ymax = y_range.log.max;
	if ( c_ymax == valueAxis.maxZoomed )
	  c_ymax *= 1.001;
	valueAxis.max = c_ymax;
console.log('Y range reset to:', y_range.log.min, c_ymax);
	setTimeout(function() {
	  valueAxis.zoomToValues(y_range.log.min, c_ymax);
	}, 200);
  } else {  // From log to lin
	valueAxis.min = y_range.lin.min;
	valueAxis.logarithmic = false;
	c_ymax = y_range.lin.max;
	if ( c_ymax == valueAxis.maxZoomed )
	  c_ymax *= 1.001;
	valueAxis.max = c_ymax;
	valueAxis.zoomToValues(y_range.lin.min, c_ymax);
  }
}


//
// -- Set X and Y plot range to fixed ranges

function xy_range_set() {
// Note: need to parse to Float. It also requires "0.nnn" and not ".nnn"
  var x_size = vxAxis.max - vxAxis.min;
  if ( x_size <= 0 )
	x_size = aux.modinfo[c_imod].x_step;

  var vx_min = parseFloat(xyin_ranges.xmin.value !== '' ? xyin_ranges.xmin.value : vxAxis.min);
  var vx_max = parseFloat(xyin_ranges.xmax.value !== '' ? xyin_ranges.xmax.value : vxAxis.max);

  var y_min = xyin_ranges.ymin.value !== '' ? parseFloat(xyin_ranges.ymin.value) : valueAxis.min;
  var y_max = xyin_ranges.ymax.value !== '' ? parseFloat(xyin_ranges.ymax.value) : valueAxis.max;

// Some checks
  if ( vx_min > vx_max ) {
	var tmp = vx_max;
	vx_max = vx_min;
	vx_min = tmp;
  } else if ( vx_min == vx_max )
	vx_max = vx_min + aux.modinfo[c_imod].x_step; 

  if ( y_min > y_max ) {
        var tmp = y_max;
        y_max = y_min;
        y_min = tmp;
  } else if ( y_min == y_max )
        return false;

/* Do not touch valueAxis min/max
  if ( y_min !== valueAxis.min || y_max !== valueAxis.max ) {
	valueAxis.strictMinMax = true;
	if ( y_min !== valueAxis.min )
	  valueAxis.min = y_min;

	if ( y_max !== valueAxis.max )
	  valueAxis.max = y_max;
  }
*/

  if ( vx_min != vxAxis.min || vx_max != vxAxis.max )
	vxAxis.zoomToValues(vx_min, vx_max);

// A delay is necessary to have the Y zoom
  setTimeout(function() {
console.log('Zoom to Y values:', y_min, y_max);
	valueAxis.zoomToValues(y_min, y_max);
  }, 300);

}


// -- Reset X and Y plot range to initial values

function xy_range_reset() {
  set_x_range();
  set_y_range();
  xy_rangein_reset();  // Clear manual range input fields
console.log('reset X, Y range:', vxAxis.min, vxAxis.max, valueAxis.min, valueAxis.max);
  vxAxis.zoomToValues(vxAxis.min, vxAxis.max);
  valueAxis.zoomToValues(valueAxis.min, valueAxis.max);

  curXY.text = '';
}


// -- Clear range input fields

function xy_rangein_reset() {
  xyin_ranges.xmin.value = '';
  xyin_ranges.xmax.value = '';
  xyin_ranges.ymin.value = '';
  xyin_ranges.ymax.value = '';
}


//
// -- Show/hide the components / models / extra log tables

function gfit_table_toggle(id) {
  var   divid = id +'-div',
	e = document.getElementById(divid),
	sdiv = document.getElementById('fitlog_selector'),  // Selector divs
	tdiv = document.getElementById('fitlog_tables'),    // Table divs
	i = 0;

  while (tdiv.childNodes[i]) {
    if ( tdiv.childNodes[i].id !== divid || ! isHidden(e) ) { 
	tdiv.childNodes[i].className = 'div-hide';
	sdiv.childNodes[i].className = 'toggle_table-hdr';
	sdiv.childNodes[i].childNodes[0].className = 'div-show-inline';
	sdiv.childNodes[i].childNodes[1].className = 'div-hide';
    } else {
	tdiv.childNodes[i].className = 'out_table rep_div-show';
	sdiv.scrollIntoView();
	sdiv.childNodes[i].className = 'toggle_table-hdr div-selected';
	sdiv.childNodes[i].childNodes[0].className = 'div-hide';
	sdiv.childNodes[i].childNodes[1].className = 'div-show-inline';
	//e.className = 'out_table rep_div-show';
	//document.getElementById(id +'_sect').className = 'toggle_table-hdr div-selected';
	//document.getElementById(id +'_angle_down').className = 'div-hide';
	//document.getElementById(id +'_angle_up').className = 'div-show-inline';
    }
    i++;
  }
}


//
// -- Download the full original JSON data

function saveJsonObj(filename, obj) {
  var a = document.createElement('a');
  var file = new Blob([JSON.stringify(obj)], {type: 'text/plain'});

  a.href = URL.createObjectURL(file);
  a.setAttribute('download', filename);
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}


//
// -- Display input JSON formatted fit results in table format
// -- Params:
//    obj:    the json object
//    type:   0=Model components + parameters, 1=fit_results, 2=extra
//    tab_id: the (html div) id to give to the created table.
//	      For extra tables this is just an integer ith table id.

var tableFromJson = function(obj, type, tab_id) {
  if ( type !== 2 && (obj == undefined || obj.show == undefined) )
	return;

  var tlab = document.createElement('div'),
	contentdiv, comp, cname, title;

// Define component/evaluations reference object and header from type

  if ( type !== 2 )
	comp = stripansi(obj.show);

//console.log(comp);

  contentdiv = document.createElement('div');

  switch (type) {  // Model
    case 0:
	title = '<div id="'+ tab_id +'_angle_down" class="div-hide"><svg class="icon-angle" width="12" height="18"><use href="#angle-down"></use></svg></div>'+
'<div id="'+ tab_id +'_angle_up" class="div-show-inline"><svg class="icon-angle" width="12" height="18"><use href="#angle-up"></use></svg></div>'+
'<span class="ud-angle-l">Model</span>';
	tlab.setAttribute('id', tab_id +'_sect');
	tlab.setAttribute('class', 'toggle_table-hdr div-selected');
	tlab.setAttribute('onclick', "gfit_table_toggle('"+ tab_id +"')");

	var div = document.createElement('div');
	var pre = document.createElement('pre');
	pre.setAttribute('class', 'pre_res');

	var cs = comp.split('\n');
	cs[0] = '<span style="color: var(--green)">'+ cs[0] +'</span>';
	cp = cs[2].split('');

	for (var i = 0; i < cp.length; i++)
		cp[i] = '<span style="color: var(--light); background-color: var(--dark);">'+ cp[i] +'</span>'; 
	cs[2] = cp.join('');
	var ips = cs.indexOf('Parameters:');
	cs[ips] = '<span style="color: var(--green)">'+ cs[ips] +'</span>';
	cp = cs[ips+2].split('');
	for (var i = 0; i < cp.length; i++)
		cp[i] = '<span style="color: var(--light); background-color: var(--dark);">'+ cp[i] +'</span>'; 
	cs[ips+2] = cp.join('');

	comp = cs.join('\n');
	pre.innerHTML = comp;
	div.appendChild(pre);
	contentdiv.appendChild(div);

	tlab.innerHTML = title;

// Create a table with its id
	tabdiv = document.createElement('div');
	tabdiv.appendChild(tlab);
	tabdiv.appendChild(contentdiv);

	break;

    case 1:
	// The summary table
	var div = document.createElement('div');
	div.setAttribute('class', 'summ-div');
	div.setAttribute('id', 'summ-div');

	var cs = comp.split('\n');
	cs[0] = '<span style="color: var(--green)">'+ cs[0] +'</span>';
	comp = cs.join('\n');
	comp = comp.replace(/OK/i, '<span style="color: var(--green)">OK</span>');

	var pre = document.createElement('pre');
	pre.setAttribute('class', 'pre_res_bf');
	pre.innerHTML = comp;
	div.appendChild(pre);
	contentdiv.appendChild(div);

	break;

    case 2:  // Extra tables 
	//comp = obj.show;
	comp = obj;
	tab_id = 'extra_table'+ tab_id;  // Must be unique

	title = '<div id="'+ tab_id +'_angle_down" class="div-show-inline"><svg class="icon-angle" width="12" height="18"><use href="#angle-down"></use></svg></div>'+
'<div id="'+ tab_id +'_angle_up" class="div-hide"><svg class="icon-angle" width="12" height="18"><use href="#angle-up"></use></svg></div>'+
'<span class="ud-angle-l">'+ comp.label +'</span>';

	tlab.setAttribute('id', tab_id +'_sect');
	tlab.setAttribute('class', 'toggle_table-hdr');
	tlab.setAttribute('onclick', "gfit_table_toggle('"+ tab_id +"')");

	tlab.innerHTML = title;

	var div = document.createElement('div');
	tab = document.createElement('table');
	div.appendChild(tab);

// Create table header row using the field names
	hdr = tab.createTHead();
	tr = hdr.insertRow(0);
	var col = Object.keys(comp.fields);

	for (var i = 0; i < col.length; i++) {
	  var th = document.createElement('th');
	  th.innerHTML = col[i];
	  tr.appendChild(th);
	}

// Table body 
	tb = tab.appendChild(document.createElement('tbody'));
	var nc = comp.fields[col[0]].data.length;  // Number of rows

	for (var i = 0; i < nc; i++) {
	  tr = tb.insertRow(-1);

	  for (var j = 0; j < col.length; j++) {
		tabCell = tr.insertCell(-1);
		tabCell.innerHTML = comp.fields[col[j]].data[i];
	  }
	}
	contentdiv.appendChild(div);

	break;

    default:
	console.log(`Sorry, option not recognised: ${type}.`);
  }



  if ( tab_id !== undefined )
	contentdiv.setAttribute('id', tab_id +'-div');

  if ( type == 2 )  // Extra tables hidden by default
	contentdiv.setAttribute('class', 'div-hide');
  else
	contentdiv.setAttribute('class', 'out_table rep_div-show');


// Selector label and table returned separately
  return {"selector": tlab, "table": contentdiv};
}


//
// -- The fit log tables sections

function createFitLogTabs() {
  var divSelectData = document.getElementById('fitlog_selector');
  var divShowData = document.getElementById('fitlog_tables');
  var divFitRes = document.getElementById('fitres_div');
  var tabdiv, p;

  divSelectData.innerHTML = '';
  divShowData.innerHTML = '';
  divFitRes.innerHTML = '';

  if ( aux.is_multimodel )
	p = chart_data[i_mod][c_imod];
  else
	p = chart_data[i_mod];
  tabdiv = tableFromJson(p, 0, 'comp_table');

  divSelectData.appendChild(tabdiv.selector);  // Add the components + evaluations table to the container
  divShowData.appendChild(tabdiv.table);


// Extra tables in a separate div, if they exist for the current evaluations.

  var n_extratab = 0;
  if ( tab_extra[c_imod] !== undefined )
	n_extratab = Object.keys(tab_extra[c_imod]).length;

  if ( n_extratab !== 0 ) {
console.log('There are '+ n_extratab +' extra tables.');

//var divShowExtra = document.createElement('div');
//divSelectExtra.style.borderLeft = '3px solid #069';

    var extratabs = Object.keys(tab_extra[c_imod]);
    for (var i = 0; i < n_extratab; i++) {
	tabdiv = tableFromJson(tab_extra[c_imod][extratabs[i]], 2, i);
	if ( i == 0 )
	  tabdiv.selector.style.borderLeft = '3px solid #ccc';
	divSelectData.appendChild(tabdiv.selector);  // Add the extra table to the container
	divShowData.appendChild(tabdiv.table);
    }
//divShowData.appendChild(divShowExtra);
  } //else
//divShowExtra.classList.add('div-hide');

  if ( i_fit >= 0 ) {
    tabdiv = tableFromJson(chart_data[i_fit], 1, 'fitres_table');

    if ( tabdiv !== undefined )
	divFitRes.appendChild(tabdiv.table);
  }

}
</script>

</div>

<div class="trailer"></div>

</body>
</html>
